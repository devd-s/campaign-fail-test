<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campaign Management System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .section {
            margin-bottom: 40px;
        }

        .section-title {
            font-size: 1.8rem;
            color: #333;
            margin-bottom: 20px;
            border-bottom: 3px solid #4facfe;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        input[type="text"], textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus, textarea:focus {
            outline: none;
            border-color: #4facfe;
        }

        textarea {
            height: 100px;
            resize: vertical;
        }

        .btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
        }

        .btn-danger:hover {
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #51cf66 0%, #40c057 100%);
        }

        .btn-success:hover {
            box-shadow: 0 5px 15px rgba(81, 207, 102, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffd43b 0%, #fab005 100%);
            color: #333;
        }

        .btn-warning:hover {
            box-shadow: 0 5px 15px rgba(255, 212, 59, 0.4);
        }

        .campaign-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .campaign-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 12px;
            padding: 20px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .campaign-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .campaign-name {
            font-size: 1.3rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 8px;
        }

        .campaign-description {
            color: #666;
            margin-bottom: 12px;
            line-height: 1.5;
        }

        .campaign-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 15px;
        }

        .status-draft {
            background: #e9ecef;
            color: #6c757d;
        }

        .status-validated {
            background: #d4edda;
            color: #155724;
        }

        .status-setup_complete {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-launched {
            background: #d4edda;
            color: #155724;
        }

        .campaign-meta {
            font-size: 0.9rem;
            color: #888;
            margin-bottom: 15px;
        }

        .campaign-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #f5c6cb;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #c3e6cb;
        }

        .api-status {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .api-online {
            background: #d4edda;
            color: #155724;
        }

        .api-offline {
            background: #f8d7da;
            color: #721c24;
        }

        .curl-section {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }

        .curl-command {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
            margin: 10px 0;
            white-space: pre-wrap;
            word-break: break-all;
            position: relative;
        }

        .curl-command::before {
            content: "$ ";
            color: #68d391;
            font-weight: bold;
        }

        .copy-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #4299e1;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .copy-btn:hover {
            background: #3182ce;
        }

        .response-container {
            margin: 15px 0;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            overflow: hidden;
        }

        .response-header {
            background: #4a5568;
            color: white;
            padding: 10px 15px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-code {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-200 { background: #48bb78; color: white; }
        .status-400 { background: #ed8936; color: white; }
        .status-404 { background: #e53e3e; color: white; }
        .status-500 { background: #e53e3e; color: white; }

        .response-body {
            background: #1a202c;
            color: #e2e8f0;
            padding: 15px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }

        .curl-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
        }

        .demo-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
        }

        .demo-title {
            font-size: 1.5rem;
            margin-bottom: 15px;
            text-align: center;
        }

        @media (max-width: 768px) {
            .campaign-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .content {
                padding: 20px;
            }

            .curl-command {
                font-size: 12px;
            }

            .curl-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Campaign Management System</h1>
            <p>Create, manage, and launch marketing campaigns</p>
            <div id="apiStatus" class="api-status">Checking API status...</div>
        </div>

        <div class="content">
            <!-- Create Campaign Section -->
            <div class="section">
                <h2 class="section-title">Create New Campaign</h2>
                <form id="campaignForm">
                    <div class="form-group">
                        <label for="campaignName">Campaign Name</label>
                        <input type="text" id="campaignName" placeholder="Enter campaign name" required>
                    </div>
                    <div class="form-group">
                        <label for="campaignDescription">Description</label>
                        <textarea id="campaignDescription" placeholder="Enter campaign description" required></textarea>
                    </div>
                    <button type="submit" class="btn">Create Campaign</button>
                </form>
                <div id="createStatus"></div>
            </div>

            <!-- Campaign List Section -->
            <div class="section">
                <h2 class="section-title">Existing Campaigns</h2>
                <button id="refreshBtn" class="btn">Refresh Campaigns</button>
                <div id="campaignsList">
                    <div class="loading">Loading campaigns...</div>
                </div>
            </div>

            <!-- Curl Commands Demo Section -->
            <div class="section">
                <div class="demo-section">
                    <h2 class="demo-title">🚀 API Testing with Curl Commands</h2>
                    <p>Execute curl commands directly from the browser and see raw API responses with status codes</p>
                </div>
                
                <div class="curl-section">
                    <h3>Quick Demo Commands</h3>
                    <div class="curl-buttons">
                        <button class="btn" onclick="executeCurl('api-status')">Check API Status</button>
                        <button class="btn" onclick="executeCurl('list-campaigns')">List All Campaigns</button>
                        <button class="btn btn-success" onclick="executeCurl('create-campaign')">Create Demo Campaign</button>
                        <button class="btn btn-warning" onclick="executeCurl('full-flow')">Execute Full Flow (Will Fail)</button>
                    </div>
                    
                    <div id="curlResults"></div>
                </div>

                <div class="curl-section">
                    <h3>Custom Campaign Flow</h3>
                    <div class="form-group">
                        <label for="testCampaignId">Campaign ID for Testing:</label>
                        <input type="number" id="testCampaignId" placeholder="Enter campaign ID" value="1">
                    </div>
                    <div class="curl-buttons">
                        <button class="btn btn-warning" onclick="executeFlowStep('validate')">1. Validate Campaign</button>
                        <button class="btn btn-success" onclick="executeFlowStep('setup')">2. Setup Campaign</button>
                        <button class="btn btn-danger" onclick="executeFlowStep('launch')">3. Launch Campaign (DB Error)</button>
                        <button class="btn" onclick="executeFlowStep('full-launch')">Execute Full Flow</button>
                    </div>
                    
                    <div id="flowResults"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:7000';
        
        // DOM Elements
        const apiStatus = document.getElementById('apiStatus');
        const campaignForm = document.getElementById('campaignForm');
        const campaignsList = document.getElementById('campaignsList');
        const refreshBtn = document.getElementById('refreshBtn');
        const createStatus = document.getElementById('createStatus');

        // Check API status on load
        checkApiStatus();
        loadCampaigns();

        // Event listeners
        campaignForm.addEventListener('submit', createCampaign);
        refreshBtn.addEventListener('click', loadCampaigns);

        async function checkApiStatus() {
            try {
                const response = await fetch(`${API_BASE}/api/`);
                if (response.ok) {
                    const data = await response.json();
                    apiStatus.textContent = `API Status: ${data.status}`;
                    apiStatus.className = 'api-status api-online';
                } else {
                    throw new Error('API not responding');
                }
            } catch (error) {
                apiStatus.textContent = 'API Status: Offline';
                apiStatus.className = 'api-status api-offline';
                showError('API is not available. Please ensure the FastAPI server is running on port 7000.');
            }
        }

        async function createCampaign(event) {
            event.preventDefault();
            
            const name = document.getElementById('campaignName').value;
            const description = document.getElementById('campaignDescription').value;
            
            try {
                const response = await fetch(`${API_BASE}/campaigns/create?name=${encodeURIComponent(name)}&description=${encodeURIComponent(description)}`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    const campaign = await response.json();
                    showSuccess(`Campaign "${campaign.name}" created successfully with ID: ${campaign.id}`);
                    campaignForm.reset();
                    loadCampaigns(); // Refresh the list
                } else {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to create campaign');
                }
            } catch (error) {
                showError(`Error creating campaign: ${error.message}`);
            }
        }

        async function loadCampaigns() {
            campaignsList.innerHTML = '<div class="loading">Loading campaigns...</div>';
            
            try {
                const response = await fetch(`${API_BASE}/campaigns/`);
                if (response.ok) {
                    const campaigns = await response.json();
                    displayCampaigns(campaigns);
                } else {
                    throw new Error('Failed to fetch campaigns');
                }
            } catch (error) {
                campaignsList.innerHTML = `<div class="error">Error loading campaigns: ${error.message}</div>`;
            }
        }

        function displayCampaigns(campaigns) {
            if (campaigns.length === 0) {
                campaignsList.innerHTML = '<div class="loading">No campaigns found. Create your first campaign above!</div>';
                return;
            }

            const campaignsHtml = campaigns.map(campaign => `
                <div class="campaign-card">
                    <div class="campaign-name">${escapeHtml(campaign.name)}</div>
                    <div class="campaign-description">${escapeHtml(campaign.description)}</div>
                    <div class="campaign-status status-${campaign.status}">${campaign.status}</div>
                    <div class="campaign-meta">
                        <div>ID: ${campaign.id}</div>
                        <div>Created: ${new Date(campaign.created_at).toLocaleString()}</div>
                        ${campaign.launched_at ? `<div>Launched: ${new Date(campaign.launched_at).toLocaleString()}</div>` : ''}
                        <div>Active: ${campaign.is_active ? 'Yes' : 'No'}</div>
                    </div>
                    <div class="campaign-actions">
                        ${getCampaignActions(campaign)}
                    </div>
                </div>
            `).join('');

            campaignsList.innerHTML = `<div class="campaign-grid">${campaignsHtml}</div>`;
        }

        function getCampaignActions(campaign) {
            let actions = [];
            
            if (campaign.status === 'draft') {
                actions.push(`<button class="btn btn-warning" onclick="validateCampaign(${campaign.id})">Validate</button>`);
            } else if (campaign.status === 'validated') {
                actions.push(`<button class="btn btn-success" onclick="setupCampaign(${campaign.id})">Setup</button>`);
            } else if (campaign.status === 'setup_complete') {
                actions.push(`<button class="btn btn-danger" onclick="launchCampaign(${campaign.id})">Launch (Will Fail)</button>`);
                actions.push(`<button class="btn" onclick="fullLaunchFlow(${campaign.id})">Full Flow</button>`);
            }
            
            return actions.join('');
        }

        async function validateCampaign(campaignId) {
            try {
                const response = await fetch(`${API_BASE}/campaigns/${campaignId}/validate`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.is_valid) {
                        showSuccess(`Campaign ${campaignId} validated successfully!`);
                        loadCampaigns();
                    } else {
                        showError(`Validation failed: ${result.validation_errors.join(', ')}`);
                    }
                } else {
                    const error = await response.json();
                    throw new Error(error.detail || 'Validation failed');
                }
            } catch (error) {
                showError(`Error validating campaign: ${error.message}`);
            }
        }

        async function setupCampaign(campaignId) {
            try {
                const response = await fetch(`${API_BASE}/campaigns/${campaignId}/setup`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showSuccess(`Campaign ${campaignId} setup completed!`);
                    loadCampaigns();
                } else {
                    const error = await response.json();
                    throw new Error(error.detail || 'Setup failed');
                }
            } catch (error) {
                showError(`Error setting up campaign: ${error.message}`);
            }
        }

        async function launchCampaign(campaignId) {
            try {
                const response = await fetch(`${API_BASE}/campaigns/${campaignId}/launch`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    showSuccess(`Campaign ${campaignId} launched successfully!`);
                    loadCampaigns();
                } else {
                    const error = await response.json();
                    showError(`Launch failed as expected: ${error.detail.message} (${error.detail.error_type})`);
                }
            } catch (error) {
                showError(`Error launching campaign: ${error.message}`);
            }
        }

        async function fullLaunchFlow(campaignId) {
            try {
                const response = await fetch(`${API_BASE}/campaigns/${campaignId}/full-launch`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.status === 'failed') {
                        showError(`Full launch flow failed at ${result.step}: ${result.error.message || result.error}`);
                    } else {
                        showSuccess(`Full launch flow completed successfully!`);
                    }
                    loadCampaigns();
                } else {
                    const error = await response.json();
                    throw new Error(error.detail || 'Full launch flow failed');
                }
            } catch (error) {
                showError(`Error in full launch flow: ${error.message}`);
            }
        }

        function showError(message) {
            createStatus.innerHTML = `<div class="error">${escapeHtml(message)}</div>`;
            setTimeout(() => createStatus.innerHTML = '', 5000);
        }

        function showSuccess(message) {
            createStatus.innerHTML = `<div class="success">${escapeHtml(message)}</div>`;
            setTimeout(() => createStatus.innerHTML = '', 5000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Auto-refresh campaigns every 30 seconds
        setInterval(loadCampaigns, 30000);

        // Curl command execution functions
        async function executeCurl(commandType) {
            const resultsDiv = document.getElementById('curlResults');
            let curlCommand = '';
            let fetchOptions = {};
            let url = '';

            switch(commandType) {
                case 'api-status':
                    curlCommand = `curl -X GET "${API_BASE}/api/"`;
                    url = `${API_BASE}/api/`;
                    fetchOptions = { method: 'GET' };
                    break;
                case 'list-campaigns':
                    curlCommand = `curl -X GET "${API_BASE}/campaigns/"`;
                    url = `${API_BASE}/campaigns/`;
                    fetchOptions = { method: 'GET' };
                    break;
                case 'create-campaign':
                    const timestamp = new Date().getTime();
                    curlCommand = `curl -X POST "${API_BASE}/campaigns/create?name=Demo%20Campaign%20${timestamp}&description=Created%20via%20curl%20demo"`;
                    url = `${API_BASE}/campaigns/create?name=Demo%20Campaign%20${timestamp}&description=Created%20via%20curl%20demo`;
                    fetchOptions = { method: 'POST' };
                    break;
                case 'full-flow':
                    // First create a campaign, then execute full flow
                    await executeCurl('create-campaign');
                    setTimeout(() => executeFullFlowDemo(), 1000);
                    return;
            }

            await executeAndDisplayCurl(curlCommand, url, fetchOptions, resultsDiv);
        }

        async function executeFlowStep(step) {
            const campaignId = document.getElementById('testCampaignId').value;
            const resultsDiv = document.getElementById('flowResults');
            
            if (!campaignId) {
                showError('Please enter a valid campaign ID');
                return;
            }

            let curlCommand = '';
            let url = '';
            let fetchOptions = { method: 'POST' };

            switch(step) {
                case 'validate':
                    curlCommand = `curl -X POST "${API_BASE}/campaigns/${campaignId}/validate"`;
                    url = `${API_BASE}/campaigns/${campaignId}/validate`;
                    break;
                case 'setup':
                    curlCommand = `curl -X POST "${API_BASE}/campaigns/${campaignId}/setup"`;
                    url = `${API_BASE}/campaigns/${campaignId}/setup`;
                    break;
                case 'launch':
                    curlCommand = `curl -X POST "${API_BASE}/campaigns/${campaignId}/launch"`;
                    url = `${API_BASE}/campaigns/${campaignId}/launch`;
                    break;
                case 'full-launch':
                    curlCommand = `curl -X POST "${API_BASE}/campaigns/${campaignId}/full-launch"`;
                    url = `${API_BASE}/campaigns/${campaignId}/full-launch`;
                    break;
            }

            await executeAndDisplayCurl(curlCommand, url, fetchOptions, resultsDiv);
        }

        async function executeFullFlowDemo() {
            // Get the latest campaign ID
            try {
                const response = await fetch(`${API_BASE}/campaigns/`);
                const campaigns = await response.json();
                if (campaigns.length > 0) {
                    const latestCampaign = campaigns[campaigns.length - 1];
                    document.getElementById('testCampaignId').value = latestCampaign.id;
                    
                    const resultsDiv = document.getElementById('curlResults');
                    const curlCommand = `curl -X POST "${API_BASE}/campaigns/${latestCampaign.id}/full-launch"`;
                    const url = `${API_BASE}/campaigns/${latestCampaign.id}/full-launch`;
                    
                    await executeAndDisplayCurl(curlCommand, url, { method: 'POST' }, resultsDiv);
                }
            } catch (error) {
                console.error('Error in full flow demo:', error);
            }
        }

        async function executeAndDisplayCurl(curlCommand, url, fetchOptions, resultsDiv) {
            // Display the curl command
            const commandDiv = document.createElement('div');
            commandDiv.innerHTML = `
                <div class="curl-command">
                    <button class="copy-btn" onclick="copyToClipboard('${curlCommand.replace(/'/g, "\\'")}')">Copy</button>
                    ${escapeHtml(curlCommand)}
                </div>
            `;

            // Execute the request
            try {
                const startTime = Date.now();
                const response = await fetch(url, fetchOptions);
                const endTime = Date.now();
                const responseTime = endTime - startTime;
                
                let responseData;
                const contentType = response.headers.get('content-type');
                
                if (contentType && contentType.includes('application/json')) {
                    responseData = await response.json();
                } else {
                    responseData = await response.text();
                }

                // Display the response
                const responseDiv = document.createElement('div');
                responseDiv.innerHTML = `
                    <div class="response-container">
                        <div class="response-header">
                            <span>Response</span>
                            <span>
                                <span class="status-code status-${Math.floor(response.status/100)*100}">
                                    ${response.status} ${response.statusText}
                                </span>
                                <span style="margin-left: 10px; font-size: 12px;">${responseTime}ms</span>
                            </span>
                        </div>
                        <div class="response-body">${formatJson(responseData)}</div>
                    </div>
                `;

                // Add both command and response to results
                const fullResult = document.createElement('div');
                fullResult.style.marginBottom = '20px';
                fullResult.appendChild(commandDiv);
                fullResult.appendChild(responseDiv);
                
                resultsDiv.insertBefore(fullResult, resultsDiv.firstChild);

                // Auto-refresh campaigns if this was a campaign operation
                if (url.includes('/campaigns/')) {
                    setTimeout(loadCampaigns, 500);
                }

            } catch (error) {
                const errorDiv = document.createElement('div');
                errorDiv.innerHTML = `
                    <div class="response-container">
                        <div class="response-header">
                            <span>Error</span>
                            <span class="status-code status-500">Network Error</span>
                        </div>
                        <div class="response-body">Error: ${escapeHtml(error.message)}</div>
                    </div>
                `;

                const fullResult = document.createElement('div');
                fullResult.style.marginBottom = '20px';
                fullResult.appendChild(commandDiv);
                fullResult.appendChild(errorDiv);
                
                resultsDiv.insertBefore(fullResult, resultsDiv.firstChild);
            }
        }

        function formatJson(data) {
            if (typeof data === 'string') {
                return escapeHtml(data);
            }
            return escapeHtml(JSON.stringify(data, null, 2));
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                // Show temporary success message
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = 'Copied!';
                btn.style.background = '#48bb78';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '#4299e1';
                }, 1000);
            }).catch(err => {
                console.error('Failed to copy text: ', err);
            });
        }
    </script>
</body>
</html>